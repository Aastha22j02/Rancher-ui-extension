{"remainingRequest":"/home/ubuntu/susecon-2024-ext-demo/node_modules/thread-loader/dist/cjs.js!/home/ubuntu/susecon-2024-ext-demo/node_modules/babel-loader/lib/index.js!/home/ubuntu/susecon-2024-ext-demo/node_modules/ts-loader/index.js??ref--15-3!/home/ubuntu/susecon-2024-ext-demo/pkg/kubecost/kubecostModule.ts","dependencies":[{"path":"/home/ubuntu/susecon-2024-ext-demo/pkg/kubecost/kubecostModule.ts","mtime":1725268750265},{"path":"/home/ubuntu/susecon-2024-ext-demo/pkg/kubecost/babel.config.js","mtime":1725268750261},{"path":"/home/ubuntu/susecon-2024-ext-demo/node_modules/cache-loader/dist/cjs.js","mtime":1725271299021},{"path":"/home/ubuntu/susecon-2024-ext-demo/node_modules/thread-loader/dist/cjs.js","mtime":1725271299040},{"path":"/home/ubuntu/susecon-2024-ext-demo/node_modules/babel-loader/lib/index.js","mtime":1725271298942},{"path":"/home/ubuntu/susecon-2024-ext-demo/node_modules/ts-loader/index.js","mtime":1725271299135}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IHsgQ0FUQUxPRyB9IGZyb20gJ0BzaGVsbC9jb25maWcvdHlwZXMnOwphc3luYyBmdW5jdGlvbiBpc0t1YmVjb3N0SW5zdGFsbGVkKGN0eCkgewogIGlmIChjdHguJHN0b3JlLmdldHRlcnNbYGNsdXN0ZXIvY2FuTGlzdGBdKENBVEFMT0cuQVBQKSkgewogICAgY29uc3QgcmVzID0gKGF3YWl0IGN0eC4kc3RvcmUuZGlzcGF0Y2goYGNsdXN0ZXIvZmluZEFsbGAsIHsKICAgICAgdHlwZTogQ0FUQUxPRy5BUFAKICAgIH0pKSB8fCBbXTsKICAgIGNvbnN0IGFwcCA9IHJlcy5maW5kKGFwcCA9PiBhcHAuaWQuaW5jbHVkZXMoJ2t1YmVjb3N0JykpOwogICAgcmV0dXJuIGFwcDsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEt1YmVjb3N0RGF0YShvcHRpb25zKSB7CiAgdmFyIF9rdWJlY29zdEFwcCRtZXRhZGF0YTsKICBjb25zdCBrdWJlY29zdEFwcCA9IGF3YWl0IGlzS3ViZWNvc3RJbnN0YWxsZWQob3B0aW9ucy5jdHgpOwogIGlmICgha3ViZWNvc3RBcHApIHsKICAgIHJldHVybiB7CiAgICAgIHR5cGU6ICdlcnJvcicsCiAgICAgIG1zZzogb3B0aW9ucy5jdHgudCgna3ViZWNvc3QuYXBwTm90SW5zdGFsbGVkJykKICAgIH07CiAgfQogIGNvbnN0IHRhcmdldE5hbWVzcGFjZSA9IG9wdGlvbnMudGFyZ2V0TmFtZXNwYWNlOwogIGNvbnN0IHByZWZpeCA9IGAvazhzL2NsdXN0ZXJzLyR7b3B0aW9ucy5jbHVzdGVySWR9YDsKICBjb25zdCBuYW1lc3BhY2UgPSAoKF9rdWJlY29zdEFwcCRtZXRhZGF0YSA9IGt1YmVjb3N0QXBwLm1ldGFkYXRhKSA9PT0gbnVsbCB8fCBfa3ViZWNvc3RBcHAkbWV0YWRhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9rdWJlY29zdEFwcCRtZXRhZGF0YS5uYW1lc3BhY2UpIHx8ICdrdWJlY29zdCc7CiAgY29uc3Qgc2VydmljZSA9ICdodHRwOmt1YmVjb3N0LWNvc3QtYW5hbHl6ZXI6OTA5MCc7IC8vIGhhcmRjb2RlZCBmb3Igbm93Li4uCiAgY29uc3QgcGF0aCA9IGBtb2RlbC9hbGxvY2F0aW9uP3dpbmRvdz0ke29wdGlvbnMud2luZG93IHx8ICcxZCd9JmFnZ3JlZ2F0ZT0ke29wdGlvbnMuYWdncmVnYXRlIHx8ICduYW1lc3BhY2UnfSZhY2N1bXVsYXRlPXRydWUmY2hhcnRUeXBlPWNvc3RvdmVydGltZSZjb3N0VW5pdD1jdW11bGF0aXZlJmV4dGVybmFsPWZhbHNlJmZpbHRlcj0maWRsZT10cnVlJmlkbGVCeU5vZGU9ZmFsc2UmaW5jbHVkZVNoYXJlZENvc3RCcmVha2Rvd249ZmFsc2Umc2hhcmVDb3N0PTAmc2hhcmVJZGxlPWZhbHNlJnNoYXJlTGFiZWxzPSZzaGFyZU5hbWVzcGFjZXM9JnNoYXJlU3BsaXQ9d2VpZ2h0ZWQmc2hhcmVUZW5hbmN5Q29zdHM9ZmFsc2VgOwogIGNvbnN0IHVybCA9IGAke3ByZWZpeH0vYXBpL3YxL25hbWVzcGFjZXMvJHtuYW1lc3BhY2V9L3NlcnZpY2VzLyR7c2VydmljZX0vcHJveHkvJHtwYXRofWA7CiAgdHJ5IHsKICAgIGNvbnN0IHJlcyA9IGF3YWl0IG9wdGlvbnMuY3R4LiRzdG9yZS5kaXNwYXRjaCgnY2x1c3Rlci9yZXF1ZXN0JywgewogICAgICB1cmwsCiAgICAgIHJlZGlyZWN0VW5hdXRob3JpemVkOiBmYWxzZQogICAgfSk7CiAgICBpZiAocmVzLmNvZGUgPT09IDIwMCkgewogICAgICB2YXIgX3JlcyRkYXRhOwogICAgICBjb25zdCBkYXRhUG9pbnRzID0gKF9yZXMkZGF0YSA9IHJlcy5kYXRhKSA9PT0gbnVsbCB8fCBfcmVzJGRhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9yZXMkZGF0YVswXTsKICAgICAgY29uc3QgbW9kZWwgPSBkYXRhUG9pbnRzID8gZGF0YVBvaW50c1t0YXJnZXROYW1lc3BhY2UgfHwgJ2NsdXN0ZXItb25lJ10gOiBudWxsOwogICAgICBpZiAoZGF0YVBvaW50cyAmJiBtb2RlbCkgewogICAgICAgIGNvbnN0IGNvc3RzID0gewogICAgICAgICAgY3B1Q29zdDogbW9kZWwuY3B1Q29zdC50b0ZpeGVkKDIpLAogICAgICAgICAgcmFtQ29zdDogbW9kZWwucmFtQ29zdC50b0ZpeGVkKDIpLAogICAgICAgICAgcHZDb3N0OiBtb2RlbC5wdkNvc3QudG9GaXhlZCgyKSwKICAgICAgICAgIGdwdUNvc3Q6IG1vZGVsLmdwdUNvc3QudG9GaXhlZCgyKSwKICAgICAgICAgIG5ldHdvcmtDb3N0OiBtb2RlbC5uZXR3b3JrQ29zdC50b0ZpeGVkKDIpLAogICAgICAgICAgbGJDb3N0OiBtb2RlbC5sb2FkQmFsYW5jZXJDb3N0LnRvRml4ZWQoMiksCiAgICAgICAgICB0b3RhbENvc3Q6IG1vZGVsLnRvdGFsQ29zdC50b0ZpeGVkKDIpCiAgICAgICAgfTsKICAgICAgICBjb25zdCBjb3N0c0RhdGEgPSBPYmplY3QuZW50cmllcyhjb3N0cykubWFwKChba2V5LCB2YWx1ZV0pID0+ICh7CiAgICAgICAgICBuYW1lOiBvcHRpb25zLmN0eC50KGBrdWJlY29zdC5jb3N0cy4ke2tleX1gKSwKICAgICAgICAgIHZhbHVlOiBgJCR7dmFsdWV9YCwKICAgICAgICAgIHJhd1ZhbHVlOiB2YWx1ZQogICAgICAgIH0pKTsKICAgICAgICByZXR1cm4gY29zdHNEYXRhOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiAnaW5mbycsCiAgICAgICAgICBtc2c6IG9wdGlvbnMuY3R4LnQoJ2t1YmVjb3N0Lm5vRGF0YUF2YWlsYWJsZScpCiAgICAgICAgfTsKICAgICAgfQogICAgfQogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICByZXR1cm4gewogICAgICB0eXBlOiAnZXJyb3InLAogICAgICBtc2c6IGVycm9yLm1lc3NhZ2UKICAgIH07CiAgfQogIHJldHVybiB7CiAgICB0eXBlOiAnZXJyb3InLAogICAgbXNnOiBvcHRpb25zLmN0eC50KCdrdWJlY29zdC51bmtub3duRXJyb3InKQogIH07Cn0="},{"version":3,"names":["CATALOG","isKubecostInstalled","ctx","$store","getters","APP","res","dispatch","type","app","find","id","includes","getKubecostData","options","_kubecostApp$metadata","kubecostApp","msg","t","targetNamespace","prefix","clusterId","namespace","metadata","service","path","window","aggregate","url","redirectUnauthorized","code","_res$data","dataPoints","data","model","costs","cpuCost","toFixed","ramCost","pvCost","gpuCost","networkCost","lbCost","loadBalancerCost","totalCost","costsData","Object","entries","map","key","value","name","rawValue","error","message"],"sources":["/home/ubuntu/susecon-2024-ext-demo/pkg/kubecost/kubecostModule.ts"],"sourcesContent":["import { CATALOG } from '@shell/config/types';\n\ninterface kubecostDataItem {\n  name: string;\n  value: string;\n}\n\ntype kubecostData = kubecostDataItem[];\n\ninterface kubecostDataOptions {\n  targetNamespace?: string;\n  clusterId: string;\n  namespace?: string;\n  aggregate?: string;\n  window?: string;\n  ctx:any;\n}\n\ninterface kubecostMsg {\n  type: string,\n  msg: string\n}\n\nasync function isKubecostInstalled(ctx: any):Promise<any> {\n  if (ctx.$store.getters[`cluster/canList`](CATALOG.APP)) {\n    const res = await ctx.$store.dispatch(`cluster/findAll`, { type: CATALOG.APP }) || [];\n    const app = res.find((app: any) => app.id.includes('kubecost'));\n\n    return app;\n  }\n\n  return null;\n}\n\nexport async function getKubecostData(options:kubecostDataOptions):Promise<kubecostData | kubecostMsg> {\n  const kubecostApp = await isKubecostInstalled(options.ctx);\n\n  if (!kubecostApp) {\n    return {\n      type: 'error',\n      msg:  options.ctx.t('kubecost.appNotInstalled')\n    };\n  }\n\n  const targetNamespace = options.targetNamespace;\n  const prefix = `/k8s/clusters/${ options.clusterId }`;\n  const namespace = kubecostApp.metadata?.namespace || 'kubecost';\n  const service = 'http:kubecost-cost-analyzer:9090'; // hardcoded for now...\n\n  const path = `model/allocation?window=${ options.window || '1d' }&aggregate=${ options.aggregate || 'namespace' }&accumulate=true&chartType=costovertime&costUnit=cumulative&external=false&filter=&idle=true&idleByNode=false&includeSharedCostBreakdown=false&shareCost=0&shareIdle=false&shareLabels=&shareNamespaces=&shareSplit=weighted&shareTenancyCosts=false`;\n  const url = `${ prefix }/api/v1/namespaces/${ namespace }/services/${ service }/proxy/${ path }`;\n\n  try {\n    const res = await options.ctx.$store.dispatch('cluster/request', { url, redirectUnauthorized: false });\n\n    if (res.code === 200) {\n      const dataPoints = res.data?.[0];\n      const model = dataPoints ? dataPoints[targetNamespace || 'cluster-one'] : null;\n\n      if (dataPoints && model) {\n        const costs = {\n          cpuCost:     model.cpuCost.toFixed(2),\n          ramCost:     model.ramCost.toFixed(2),\n          pvCost:      model.pvCost.toFixed(2),\n          gpuCost:     model.gpuCost.toFixed(2),\n          networkCost: model.networkCost.toFixed(2),\n          lbCost:      model.loadBalancerCost.toFixed(2),\n          totalCost:   model.totalCost.toFixed(2)\n        };\n\n        const costsData = Object.entries(costs).map(([key, value]) => ({\n          name:     options.ctx.t(`kubecost.costs.${ key }`),\n          value:    `$${ value }`,\n          rawValue: value\n        }));\n\n        return costsData;\n      } else {\n        return {\n          type: 'info',\n          msg:  options.ctx.t('kubecost.noDataAvailable')\n        };\n      }\n    }\n  } catch (error: any) {\n    return {\n      type: 'error',\n      msg:  error.message\n    };\n  }\n\n  return {\n    type: 'error',\n    msg:  options.ctx.t('kubecost.unknownError')\n  };\n}\n"],"mappings":"AAAA,SAASA,OAAO,QAAQ,qBAAqB;AAuB7C,eAAeC,mBAAmBA,CAACC,GAAQ;EACzC,IAAIA,GAAG,CAACC,MAAM,CAACC,OAAO,CAAC,iBAAiB,CAAC,CAACJ,OAAO,CAACK,GAAG,CAAC,EAAE;IACtD,MAAMC,GAAG,GAAG,OAAMJ,GAAG,CAACC,MAAM,CAACI,QAAQ,CAAC,iBAAiB,EAAE;MAAEC,IAAI,EAAER,OAAO,CAACK;IAAG,CAAE,CAAC,KAAI,EAAE;IACrF,MAAMI,GAAG,GAAGH,GAAG,CAACI,IAAI,CAAED,GAAQ,IAAKA,GAAG,CAACE,EAAE,CAACC,QAAQ,CAAC,UAAU,CAAC,CAAC;IAE/D,OAAOH,GAAG;;EAGZ,OAAO,IAAI;AACb;AAEA,OAAO,eAAeI,eAAeA,CAACC,OAA2B;EAAA,IAAAC,qBAAA;EAC/D,MAAMC,WAAW,GAAG,MAAMf,mBAAmB,CAACa,OAAO,CAACZ,GAAG,CAAC;EAE1D,IAAI,CAACc,WAAW,EAAE;IAChB,OAAO;MACLR,IAAI,EAAE,OAAO;MACbS,GAAG,EAAGH,OAAO,CAACZ,GAAG,CAACgB,CAAC,CAAC,0BAA0B;KAC/C;;EAGH,MAAMC,eAAe,GAAGL,OAAO,CAACK,eAAe;EAC/C,MAAMC,MAAM,GAAG,iBAAkBN,OAAO,CAACO,SAAU,EAAE;EACrD,MAAMC,SAAS,GAAG,EAAAP,qBAAA,GAAAC,WAAW,CAACO,QAAQ,cAAAR,qBAAA,uBAApBA,qBAAA,CAAsBO,SAAS,KAAI,UAAU;EAC/D,MAAME,OAAO,GAAG,kCAAkC,CAAC,CAAC;EAEpD,MAAMC,IAAI,GAAG,2BAA4BX,OAAO,CAACY,MAAM,IAAI,IAAK,cAAeZ,OAAO,CAACa,SAAS,IAAI,WAAY,sPAAsP;EACtW,MAAMC,GAAG,GAAG,GAAIR,MAAO,sBAAuBE,SAAU,aAAcE,OAAQ,UAAWC,IAAK,EAAE;EAEhG,IAAI;IACF,MAAMnB,GAAG,GAAG,MAAMQ,OAAO,CAACZ,GAAG,CAACC,MAAM,CAACI,QAAQ,CAAC,iBAAiB,EAAE;MAAEqB,GAAG;MAAEC,oBAAoB,EAAE;IAAK,CAAE,CAAC;IAEtG,IAAIvB,GAAG,CAACwB,IAAI,KAAK,GAAG,EAAE;MAAA,IAAAC,SAAA;MACpB,MAAMC,UAAU,IAAAD,SAAA,GAAGzB,GAAG,CAAC2B,IAAI,cAAAF,SAAA,uBAARA,SAAA,CAAW,CAAC,CAAC;MAChC,MAAMG,KAAK,GAAGF,UAAU,GAAGA,UAAU,CAACb,eAAe,IAAI,aAAa,CAAC,GAAG,IAAI;MAE9E,IAAIa,UAAU,IAAIE,KAAK,EAAE;QACvB,MAAMC,KAAK,GAAG;UACZC,OAAO,EAAMF,KAAK,CAACE,OAAO,CAACC,OAAO,CAAC,CAAC,CAAC;UACrCC,OAAO,EAAMJ,KAAK,CAACI,OAAO,CAACD,OAAO,CAAC,CAAC,CAAC;UACrCE,MAAM,EAAOL,KAAK,CAACK,MAAM,CAACF,OAAO,CAAC,CAAC,CAAC;UACpCG,OAAO,EAAMN,KAAK,CAACM,OAAO,CAACH,OAAO,CAAC,CAAC,CAAC;UACrCI,WAAW,EAAEP,KAAK,CAACO,WAAW,CAACJ,OAAO,CAAC,CAAC,CAAC;UACzCK,MAAM,EAAOR,KAAK,CAACS,gBAAgB,CAACN,OAAO,CAAC,CAAC,CAAC;UAC9CO,SAAS,EAAIV,KAAK,CAACU,SAAS,CAACP,OAAO,CAAC,CAAC;SACvC;QAED,MAAMQ,SAAS,GAAGC,MAAM,CAACC,OAAO,CAACZ,KAAK,CAAC,CAACa,GAAG,CAAC,CAAC,CAACC,GAAG,EAAEC,KAAK,CAAC,MAAM;UAC7DC,IAAI,EAAMrC,OAAO,CAACZ,GAAG,CAACgB,CAAC,CAAC,kBAAmB+B,GAAI,EAAE,CAAC;UAClDC,KAAK,EAAK,IAAKA,KAAM,EAAE;UACvBE,QAAQ,EAAEF;SACX,CAAC,CAAC;QAEH,OAAOL,SAAS;OACjB,MAAM;QACL,OAAO;UACLrC,IAAI,EAAE,MAAM;UACZS,GAAG,EAAGH,OAAO,CAACZ,GAAG,CAACgB,CAAC,CAAC,0BAA0B;SAC/C;;;GAGN,CAAC,OAAOmC,KAAU,EAAE;IACnB,OAAO;MACL7C,IAAI,EAAE,OAAO;MACbS,GAAG,EAAGoC,KAAK,CAACC;KACb;;EAGH,OAAO;IACL9C,IAAI,EAAE,OAAO;IACbS,GAAG,EAAGH,OAAO,CAACZ,GAAG,CAACgB,CAAC,CAAC,uBAAuB;GAC5C;AACH","ignoreList":[]}]}